---
title:   "EOS Student Comparison Metrics - FY 13-14 to FY 15-16"
output:  
  flexdashboard::flex_dashboard:
  source_code: embed
runtime: shiny

---

```{r global, include = FALSE}

#==============================================#
# ==== load packages and clear objects/log ====
#==============================================#

  # load easimple and clear objects log
  library(easimple)
  ea_start()
  
  library(flexdashboard)
  library(wesanderson)
  library(ggplot2)
  library(data.table)

#====================#
# ==== set parms ====
#====================#
  
  # set project folder
  p_dir_root <- "C:/Users/Drew/Dropbox/analysis_data/eos_excercise/data/most_recent/"
  
  # set wes anderson color scheme
  wes_pal <- wes_palette(name = "Zissou", type = "continuous")

  # set up base plot attributes / theme 
  plot_attributes <- theme(text       = element_text(size = 20),
                           plot.title = element_text(vjust = 0, colour = "black", face = "bold", size = 25))

#====================#
# ==== load data ====
#====================#
  
  # load data
  in_eos_data_long <- ea_load(paste0(p_dir_root, "eos_data_long.rdata"))
  
#===================================================#
# ==== create additional data sets for plotting ====
#===================================================#

  # copy loaded data
  eos_data <- copy(in_eos_data_long)
  
  # calculate total number of schs that closed gaps, by year
  a_cl_gaps_start_yr <- eos_data[variable == "closed_gaps", list(total_schs  = .N,
                                                                 closed_gaps = sum(value)),
                                 by = c("start_year_with_eos", "data_yr")]
  
  # create variable for schools that didn't close gaps
  a_cl_gaps_start_yr[, not_closed_gaps := closed_gaps - total_schs]
  
  # melt closed and not closed vars long
  cl_gaps_start_yr <- melt(a_cl_gaps_start_yr, measure.vars = c("closed_gaps", "not_closed_gaps"), variable.factor = FALSE)
  
  # sum by data_yr
  cl_gaps_overall <- cl_gaps_start_yr[, list(total_schs = sum(total_schs),
                                             value      = sum(value)),
                                      by = c("data_yr", "variable")]
  
  # create percentage of schools var
  cl_gaps_start_yr[, percent := value / total_schs]
  cl_gaps_overall[,  percent := value / total_schs]
  
  # cast students added variables wide, by year
  studs_added_wide <- dcast(subset(eos_data, variable != "closed_gaps"), district_id + school_id + num_of_years_of_data + start_year_with_eos + 
                              num_of_years_gaps_closed + num_of_ur_added_in_3_years + num_of_ur_added_across_district + data_yr ~ variable, 
                              value.var = c("value"))

  # set data year to character
  studs_added_wide[, data_yr := as.character(data_yr)]
  

```

Closing Gaps (Page 1) {data-orientation=columns}
=====================================  

Column
-----------------------------------------------------------------------

### Chart 1A - Gaps Closed between Underrepresented and Benchmark Students - Number of Schools

```{r, fig.width = 10, fig.height = 7}
  
  # plot - num schools closed gaps, by year
  ggplot(data = cl_gaps_overall, aes(x = data_yr, y = value, fill = variable)) + 
    geom_bar(stat = "identity", position = "identity") +
    scale_y_continuous(breaks = seq(-100, 100, 25), limits = c(-100, 100)) +
    scale_fill_manual(values = c("#3B9AB2", "#F21A00"), 
                      labels = c("Closed Gaps", "Did Not Close Gaps")) +
    theme(legend.title = element_blank()) +
    labs(x = "Year (FY)", y = "Number of Schools") +
    plot_attributes

```

### Chart 1B - Gaps Closed between Underrepresented and Benchmark Students - Percentage of Schools

```{r, fig.width = 10, fig.height = 7}
  
  # plot - perc schools closed gaps, by year
  ggplot(data = cl_gaps_overall, aes(x = data_yr, y = percent, fill = variable)) + 
    geom_bar(stat = "identity", position = "identity") +
    scale_y_continuous(breaks = seq(-1, 1, .25), limits = c(-1, 1)) +
    scale_fill_manual(values = c("#3B9AB2", "#F21A00"), 
                      guide  = FALSE) +
    theme(legend.title = element_blank()) +
    labs(x = "Year (FY)", y = "Number of Schools") +
    plot_attributes


```

Column {.tabset .tabset-fade}
-----------------------------------------------------------------------

### Chart 1C - Number of Schools by EOS Start Year

```{r, fig.width = 15, fig.height = 11}
  
  # plot - num schools closed gaps, by year, facetted by start year
  ggplot(data = cl_gaps_start_yr, aes(x = data_yr, y = value, fill = variable)) + 
    geom_bar(stat = "identity", position = "identity") + 
    facet_wrap("start_year_with_eos") +
    scale_y_continuous(breaks = seq(-75, 75, 25), limits = c(-75, 75)) +
    scale_fill_manual(values = c("#3B9AB2", "#F21A00"), 
                      guide  = FALSE) +
    theme(legend.title = element_blank()) +
    labs(x = "Year (FY)", y = "Number of Schools") +
    plot_attributes

```

### Chart 1D - Percentage of Schools by EOS Start Year

```{r, fig.width = 15, fig.height = 11}

  # plot - perc schools closed gaps, by year, facetted by start year
  ggplot(data = cl_gaps_start_yr, aes(x = data_yr, y = percent, fill = variable)) + 
    geom_bar(stat = "identity", position = "identity") +
    facet_wrap("start_year_with_eos") +
    scale_y_continuous(breaks = seq(-1, 1, .25), limits = c(-1, 1)) +
    scale_fill_manual(values = c("#3B9AB2", "#F21A00"), 
                      guide  = FALSE) +
    theme(legend.title = element_blank()) +
    labs(x = "Year (FY)", y = "Number of Schools") +
    plot_attributes

```

Underrepresented Students Added (Page 2) {data-orientation=columns}
=====================================

Inputs {.sidebar}
-----------------------------------------------------------------------

```{r}

  # define selection tab
  checkboxGroupInput(inputId = "selected_cohort", 
                     label = h3("EOS Start Year (FY):"),
                     choices = c("FY13-FY14", "FY14-FY15", "FY15-FY16"),
                     selected = c("FY13-FY14", "FY14-FY15", "FY15-FY16"))

  # define selection tab
  checkboxGroupInput(inputId ="selected_yr", 
                     label = h3("Data Year (FY):"),
                     choices = c("2014", "2015", "2016"),
                     selected = "2014")
  
  
  # Combine the selected variables into a new data frame
  selected_data <- reactive({ output <- subset(studs_added_wide, num_ap_students_added > 20 & 
                                                       chmatch(start_year_with_eos, c(input$selected_cohort), nomatch = 0) != 0 & 
                                                       chmatch(data_yr, c(input$selected_yr), nomatch = 0) != 0) })

```

Column
-----------------------------------------------------------------------

### Chart 2A - Distribution of Percentage of Underrepresented Students Added to AP/IB Overal Baseline, by Fiscal Year

```{r}


  # plot - box and whisker of percent of ur students added (total students added > 20)
  ggplot(data = subset(studs_added_wide, num_ap_students_added > 20), aes(x = data_yr, y = perc_ap_ur_students_added)) +
    geom_boxplot(colour         = "black", 
                 fill           = "#3B9AB2",
                 outlier.colour = "#F21A00") +
    stat_summary(fun.y = mean, 
                 geom  = "point", 
                 shape = 5, size = 3) +
    labs(x = "Year (FY)", 
         y = "Percent of Underrepresented 
Students Added to AP/IB 
Over Baseline") +
    plot_attributes

```

### Chart 2B - Distribution of Percentage of Underrepresented Students Added to AP/IB Overal Baseline

```{r}

  # # Combine the selected variables into a new data frame
  # selected_data <- reactive({ output <- subset(studs_added_wide, num_ap_students_added > 20 & 
  #                                                      chmatch(start_year_with_eos, c(input$selected_cohort), nomatch = 0) != 0 & 
  #                                                      chmatch(data_yr, c(input$selected_yr), nomatch = 0) != 0) })

  renderPlot({

  # plot - histogram of percent of ur students added (total students added > 20)
  ggplot(data = selected_data(), aes(x = perc_ap_ur_students_added)) +
    geom_histogram(binwidth = .05,
                   colour   = "black", fill = "#3B9AB2") +
    labs(x = "Percent of Underrepresented Students Added to AP/IB Over Baseline", y = "Number of Schools") +
    plot_attributes
    
  })

```

Percentage of Underrepresented Students Added by School (Page 3) {data-orientation=columns}
=====================================

Column {.sidebar}
-----------------------------------------------------------------------

Select the fiscal year (FY) to display in the chart to the right

```{r}

  # define selection tab
  selectInput("selected_yr", label = "Data Year:",
              choices = c("2014", "2015", "2016"), selected = "2014", multiple = TRUE)

```

Column
-----------------------------------------------------------------------

### Chart 3a

```{r}

  # Combine the selected variables into a new data frame
  selected_data <- reactive({ subset(studs_added_wide, num_ap_students_added > 20 & chmatch(data_yr, c(input$selected_yr), nomatch = 0) != 0) })

  renderPlot({

      ggplot(data = selected_data(), aes(x = num_ap_students_added, y = perc_ap_ur_students_added)) +
        geom_point()

  })

```

