---
title: "EOS Student Comparison Metrics - FY 13-14 to FY 15-16"
author: "Drew McDermott"
output:  
  flexdashboard::flex_dashboard:
  source_code: embed
runtime: shiny
---

```{r global, include = FALSE}

#==============================================#
# ==== load packages and clear objects/log ====
#==============================================#
  
  library(wesanderson)
  library(data.table)
  library(ggplot2)
  library(plotly)
  library(shiny)
  library(knitr)
  library(flexdashboard)

#====================#
# ==== set parms ====
#====================#
  
  # set working directory to code location
  setwd("C:/Users/Drew/Dropbox/github_clones/personal_code/eos_excercise")

  # set wes anderson color scheme
  wes_pal <- wes_palette(name = "Zissou", type = "continuous")

  # set up base plot attributes / theme 
  plot_attributes <- theme(text       = element_text(size = 20),
                           plot.title = element_text(vjust = 0, colour = "black", face = "bold", size = 25))

#====================#
# ==== load data ====
#====================#
  
  # load data
  load("eos_data_long.rdata")
  load("eos_data.rdata")
  
#===================================================#
# ==== create additional data sets for plotting ====
#===================================================#

  # copy loaded data
  eos_data      <- copy(out_data)
  eos_data_long <- copy(out_data_long)

  # calculate total number of schs that closed gaps, by year
  a_cl_gaps_start_yr <- eos_data_long[variable == "closed_gaps", list(total_schs  = .N,
                                                                      closed_gaps = sum(value)),
                                      by = c("start_year_with_eos", "data_yr")]
  
  # create variable for schools that didn't close gaps
  a_cl_gaps_start_yr[, not_closed_gaps := closed_gaps - total_schs]
  
  # melt closed and not closed vars long
  cl_gaps_start_yr <- melt(a_cl_gaps_start_yr, measure.vars = c("closed_gaps", "not_closed_gaps"), variable.factor = FALSE)
  
  # sum by data_yr
  cl_gaps_overall <- cl_gaps_start_yr[, list(total_schs = sum(total_schs),
                                             value      = sum(value)),
                                      by = c("data_yr", "variable")]
  
  # create percentage of schools var
  cl_gaps_start_yr[,   percent := value / total_schs]
  cl_gaps_overall[,    percent := value / total_schs]
  
#===========================================#
# ==== create summary tables to display ====
#===========================================#

  # cast students added variables wide, by year
  studs_added_wide <- dcast(subset(eos_data_long, variable != "closed_gaps"), district_id + school_id + num_of_years_of_data + start_year_with_eos + 
                              num_of_years_gaps_closed + num_of_ur_added_in_3_years + num_of_ur_added_across_district + data_yr ~ variable, 
                              value.var = c("value"))

  # set data year to character
  studs_added_wide[, data_yr := as.character(data_yr)]
  
  # add percentage closed gaps variable to closed gaps table
  a_cl_gaps_start_yr[, perc_cl_gaps := round(closed_gaps / total_schs, 2)]
  
  # calc overall avgs
  a_cohort_avgs <- eos_data[is.na(start_year_with_eos) == FALSE, list(total_schs         = .N,
                                                                      avg_yrs_data       = round(mean(num_of_years_of_data), 2),
                                                                      avg_yrs_gp_cl      = round(mean(num_of_years_gaps_closed), 2),
                                                                      avg_num_ur_add_3yr = round(mean(num_of_ur_added_in_3_years), 2)),
                            by = c("start_year_with_eos")]
  
  # take mean of select vars
  a_studs_added_avg <- studs_added_wide[, list(total_schs      = .N,
                                               avg_num_add     = round(mean(num_ap_students_added, na.rm = TRUE), 2),
                                               avg_num_ur_add  = round(mean(num_ap_ur_students_added, na.rm = TRUE), 2),
                                               avg_num_bm_add  = round(mean(num_ap_bm_students_added, na.rm = TRUE), 2),
                                               avg_perc_ur_add = round(mean(perc_ap_ur_students_added, na.rm = TRUE), 2),
                                               avg_perc_bm_add = round(mean(perc_ap_bm_students_added, na.rm = TRUE), 2)),
                                      by = c("start_year_with_eos", "data_yr")]
  
#===================================#
# ==== format tables to display ====
#===================================#
  
  # sort data by EOS start year
  setkey(a_cl_gaps_start_yr, start_year_with_eos)
  setkey(a_studs_added_avg, start_year_with_eos)

  # take absolute value of did not close variable to remove negative values
  a_cl_gaps_start_yr[, not_closed_gaps := abs(not_closed_gaps)]
  
  # rename vars for display
  setnames(a_cl_gaps_start_yr, c("EOS Start Year", "Data Year", "Total Schools", "Closed Gaps - Number of Schools", 
                                 "Did Not Close Gaps - Number of Schools", "Closed Gaps - Percentage of Schools"))

```

Closing Gaps {data-orientation=columns}
=====================================  

Column
-----------------------------------------------------------------------

### Chart 1A - Gaps Closed between Underrepresented and Benchmark Students - Number of Schools

```{r, fig.width = 10, fig.height = 7}
  
  # plot - num schools closed gaps, by year
  plot_gaps_yr <- ggplot(data = cl_gaps_overall, aes(x = data_yr, y = value, fill = variable)) + 
                    geom_bar(stat     = "identity", 
                             position = "identity") +
                    scale_y_continuous(breaks = seq(-100, 100, 25), 
                                       limits = c(-100, 100)) +
                    scale_fill_manual(values = c("#3B9AB2", "#F21A00"), 
                                      labels = c("Closed Gaps", "Did Not Close Gaps")) +
                    theme(legend.title = element_blank()) +
                    labs(x = "Year (FY)", 
                         y = "Number of Schools") +
                    plot_attributes

  # display plot
  plot(plot_gaps_yr)
  
```

### Chart 1B - Gaps Closed between Underrepresented and Benchmark Students - Percentage of Schools

```{r, fig.width = 10, fig.height = 7}
  
  # plot - perc schools closed gaps, by year
  plot_perc_gaps_yr <- ggplot(data = cl_gaps_overall, aes(x = data_yr, y = percent, fill = variable)) + 
                        geom_bar(stat     = "identity", 
                                 position = "identity") +
                        scale_y_continuous(breaks = seq(-1, 1, .25), 
                                           limits = c(-1, 1)) +
                        scale_fill_manual(values = c("#3B9AB2", "#F21A00"), 
                                          guide  = FALSE) +
                        theme(legend.title = element_blank()) +
                        labs(x = "Year (FY)", 
                             y = "Percentage of Schools") +
                        plot_attributes

  # display plot
  plot(plot_perc_gaps_yr)

```

Column {.tabset .tabset-fade}
-----------------------------------------------------------------------

### Table 1A - Summary of Gaps Closed

```{r}

  # display table
  output$table_summary_gaps <- renderDataTable(a_cl_gaps_start_yr)

  # display table
  dataTableOutput('table_summary_gaps')

```

### Chart 1C - Number of Schools by EOS Start Year

```{r, fig.width = 15, fig.height = 11}
  
  # plot - num schools closed gaps, by year, facetted by start year
  plot_gaps_yr_start_yr <- ggplot(data = cl_gaps_start_yr, aes(x = data_yr, y = value, fill = variable)) + 
                            geom_bar(stat     = "identity", 
                                     position = "identity") + 
                            facet_wrap("start_year_with_eos") +
                            scale_y_continuous(breaks = seq(-75, 75, 25), 
                                               limits = c(-75, 75)) +
                            scale_fill_manual(values = c("#3B9AB2", "#F21A00"), 
                                              guide  = FALSE) +
                            theme(legend.title = element_blank()) +
                            labs(x = "Year (FY)", 
                                 y = "Number of Schools") +
                            plot_attributes

  # display plot
  plot(plot_gaps_yr_start_yr)

```

### Chart 1D - Percentage of Schools by EOS Start Year

```{r, fig.width = 15, fig.height = 11}

  # plot - perc schools closed gaps, by year, facetted by start year
  plot_perc_gaps_yr_start_yr <- ggplot(data = cl_gaps_start_yr, aes(x = data_yr, y = percent, fill = variable)) + 
                                  geom_bar(stat     = "identity", 
                                           position = "identity") +
                                  facet_wrap("start_year_with_eos") +
                                  scale_y_continuous(breaks = seq(-1, 1, .25), 
                                                     limits = c(-1, 1)) +
                                  scale_fill_manual(values = c("#3B9AB2", "#F21A00"), 
                                                    guide  = FALSE) +
                                  theme(legend.title = element_blank()) +
                                  labs(x = "Year (FY)", 
                                       y = "Percentage of Schools") +
                                  plot_attributes

  # display plot
  plot(plot_perc_gaps_yr_start_yr)

```

Underrepresented Students Added
=====================================

Inputs {.sidebar}
-----------------------------------------------------------------------

```{r}

  # define checkboxes for cohort selection
  checkboxGroupInput(inputId = "selected_cohort_p2", 
                     label = h3("EOS Start Year (FY):"),
                     choices = c("FY13-FY14", "FY14-FY15", "FY15-FY16"),
                     selected = c("FY13-FY14", "FY14-FY15", "FY15-FY16"))

  # define checkboxes for data year selection
  checkboxGroupInput(inputId ="selected_yr_p2", 
                     label = h3("Data Year (FY):"),
                     choices = c("2014", "2015", "2016"),
                     selected = "2014")
  
  
  # combine the selected variables into a new data frame - box and whisker
  selected_data_p2a <- reactive({ output <- subset(studs_added_wide, num_ap_students_added > 20 & 
                                                       chmatch(start_year_with_eos, c(input$selected_cohort_p2), nomatch = 0) != 0) })
  
  # combine the selected variables into a new data frame - histogram
  selected_data_p2b <- reactive({ output <- subset(studs_added_wide, num_ap_students_added > 20 & 
                                                       chmatch(start_year_with_eos, c(input$selected_cohort_p2), nomatch = 0) != 0 & 
                                                       chmatch(data_yr, c(input$selected_yr_p2), nomatch = 0) != 0) })

```

Outputs
-----------------------------------------------------------------------

### Chart 2A - Distribution of Percentage of Underrepresented Students Added to AP/IB Overal Baseline, by Fiscal Year


```{r}

  # render output chart 2A
  output$plot_box_ur_added <- renderPlot({

    # plot - box and whisker of percent of ur students added (total students added > 20)
    ggplot(data = selected_data_p2a(), aes(x = data_yr, y = perc_ap_ur_students_added)) +
      geom_boxplot(colour         = "black", 
                   fill           = "#3B9AB2",
                   outlier.colour = "#F21A00") +
      stat_summary(fun.y = mean, 
                   geom  = "point", 
                   shape = 5, size = 3) +
      labs(x = "Year (FY)", 
           y = "Percent of Underrepresented 
Students Added to AP/IB 
Over Baseline") +
      plot_attributes
  
    # set plot width to 750 pixels - NEED TO FIGURE OUT ALIGNMENT
    }, width = 750)

  # display plot
  plotOutput('plot_box_ur_added')


```

### Chart 2B - Distribution of Percentage of Underrepresented Students Added to AP/IB Over Baseline

```{r}

  # render output chart 2B
  output$plot_hist_ur_added <- renderPlot({

    # plot - histogram of percent of ur students added (total students added > 20)
    ggplot(data = selected_data_p2b(), aes(x = perc_ap_ur_students_added)) +
      geom_histogram(binwidth = .05,
                     colour   = "black", 
                     fill     = "#3B9AB2") +
      labs(x = "Percent of Underrepresented Students Added to AP/IB Over Baseline", y = "Number of Schools") +
      plot_attributes
    
  })

  # display plot
  plotOutput('plot_hist_ur_added')

```

Percentage of Underrepresented Students Added by School
=====================================

Inputs {.sidebar}
-----------------------------------------------------------------------

Select the fiscal year (FY) to display in the chart to the right

```{r}

  # define checkboxes for data year selection
  checkboxGroupInput(inputId ="selected_yr_p3", 
                     label = h3("Data Year (FY):"),
                     choices = c("2014", "2015", "2016"),
                     selected = "2014")

  # combine the selected variables into a new data frame
  selected_data_p3 <- reactive({ subset(studs_added_wide, num_ap_students_added > 20 & chmatch(data_yr, c(input$selected_yr_p3), nomatch = 0) != 0) })

```

Outputs
-----------------------------------------------------------------------

### Chart 3A

```{r}

  # render output chart 3A
  output$plot_scatter_ur_added <- renderPlotly({

    # plot - scatter of schools, students added by perc ur students added (total students added > 20)
    p3a <- ggplot(data = selected_data_p3(), aes(x = num_ap_students_added, y = perc_ap_ur_students_added)) +
      geom_point(size   = 5,
                 colour = "#3B9AB2") +
      labs(x = "Total Number of Students Added to AP/IB Over Baseline", 
           y = "Percent of Underrepresented Students Added to AP/IB Over Baseline")

    # add plotly attributes
    ggplotly(p3a) %>%
      layout(xaxis = list(titlefont = list(size = 18)), 
             yaxis = list(titlefont = list(size = 15)))
        
  })

  # display plot (as plotly)
  plotlyOutput('plot_scatter_ur_added')

```

